EUI.InvoicePrepare = EUI.extend(EUI.CustomUI, {
	renderTo: "",
	cfgId: "",
    timer:3,
    searchWin:"",
    searchWin1:"",
    ComboBoxCode:"",
    ComboBoxName:"",
    ComboBoxUrl:"",
    labelName:"",
	initComponent: function() {
		var g = this;
		EUI.GridPanel({
			renderTo: this.renderTo,
			padding: 0, //设置表格的内边距
			height: "auto",
			id: g.cfgId,
            width:"1160",
			gridCfg: g.initGridTable()
		});
		g.initSearchForm();
		g.addEvents(); //
        g.initDownList();
		// EUI.getCmp(g.cfgId).setPostParams({
         //    order:[{
         //    	"name":"voucherNo",
		// 		"orderBy":"DESC"
         //    },{
         //    	"name":"groupCompanyCode",
		// 		"orderBy":"DESC"
         //    }]
		// },true);
	},
	addEvents: function() {
		var g = this;
		//删除一条发票信息
		$(".deleteRow").live("click", function() {
			if(g.cfgId == "InvoicePre1"){
                var deleteId = $(this).attr("data-id");
                // var htmls = '	<div class="import_line">';
                // var deleteId = $(this).attr("data-id");
                // htmls += '<p class="del_info">确认删除发票信息吗？</p>';
                // htmls += '	</div>';
                // htmls += '	<div class="import_line">';
                // htmls += '	<input type="button" value="取消" class="import_btn cancel_btn"/>';
                // htmls += '	<input type="button" value="确定" class="import_btn import_ok" id="delete_ok"/>';
                // htmls += '	</div>';
                // showWin(htmls);
                // $("#delete_ok").live("click", function() {
                //     //后端删除成功后删除表格内容
                //     EUI.Store({
                //         url: _ctxPath + "/avf/invoice/deleteInvoiceHead.json?id="+deleteId,
                //         type : "post",
                //         success: function (msg) {
                //             closeWin();
                //             // EUI.getCmp(g.cfgId).deleteRow($(this).attr("data-id"));
                //             // EUI.getCmp(g.cfgId).refreshGrid();
                //             window.location.href = "/avf/invoice/toWaitPage?type=enterprise";
                //         },
                //         failure: function (data) {
                //             // myMask.hide();
                //             // var htmls = "<div>"+msg.msg+"</div>";
                //             errorInfo("删除失败！");
                //         }
                //     });
                //
                // });
                var storeUrl = _ctxPath + "/avf/invoice/deleteInvoiceHead.json?id="+deleteId;
                delInfoWin("/avf/invoice/toWaitPage?type=enterprise",storeUrl);
			}else{
                errorInfo("供应商删除功能正在开发中！");
			}

		});
		//编辑发票信息
		$(".editRow").live("click",function(){
            errorInfo("编辑功能正在开发中！");
		});
        //下载文件模板
        $("#import_model").live("click", function() {
            var htmls = '<a href="/static/file/发票批量导入模板.xlsx" class="down_btn excel_down" download="发票批量导入模板.xlsx"></a>';
            // htmls += '<a href="/static/file/发票批量导入模板.xlsx"  class="down_btn txt_down" download="发票批量导入模板.xlsx"></a>';
            showWin(htmls);
        })
        //导入发票
        $("#import_ticket").live("click", function() {
            var htmls = '<div class="import_line">';
            htmls += '<form id= "import_form" name = "import_form" enctype="multipart/form-data" method="post">';
            htmls += '	<input type="text" placeholder="文件地址" id="f_file" class="importfile_input"/>';
            htmls += ' <input type="file" name="file" class="hide_upload" id="t_file" onchange="f_file.value=this.value" hidefocus>';
            htmls += ' <input type="button" value="上传文件" class="importfile_btn" />';
            htmls += '	</div>';
            htmls += '	<div class="import_line">';
            htmls += '	<input type="button" value="取消" class="import_btn cancel_btn"/>';
            htmls += '	<input type="button" value="保存" class="import_btn import_ok" id="import_ok"/>';
            htmls += '<input type="submit" style="display: none" id="sub_import" />';
            htmls += '	</div>';
            htmls += '</form>';
            showWin(htmls);
        })

        //确定导入发票
		$("#import_ok").live("click",function(){
			var fileUrl = $("#f_file").val();
            if($("#f_file").val() != "" && $("#f_file").val() != "请选择上传文件！"){
                if(fileUrl.indexOf("xls")<0 && fileUrl.indexOf("xlsx")<0)
                {
                    alert("请选择格式为.xls或.xlsx的文件！");
                    return false;
                }else{
                    var formData = new FormData($( "#import_form" )[0]);
                    $.ajax({
                        url: _ctxPath+'/avf/invoice/importInvoice.json',
                        type: 'POST',
                        data: formData,
                        async: true,
                        // cache: false,
                        contentType: false,
                        processData: false,
                        success: function (msg) {
                            if(g.cfgId == "InvoicePre1") {
                            	showToPageInfo("导入成功！","/avf/invoice/toWaitPage?type=enterprise");
							}
                            if(g.cfgId == "InvoicePre2") {
                                showToPageInfo("导入成功！","/avf/invoice/toWaitPage?type=supplier");
							}
                        },
                        error: function (msg) {
                        	var parseMsg = JSON.parse(msg.responseText);
                            errorInfo(parseMsg.msg);
                        }
                    });
				}
			}
			else{
				$("#f_file").val("请选择上传文件！");
			}
		})
        $("#changSearch").live("click",function(){
            g.searchWin.options.tableId = "表格2";
        })
        //高级查询

	},
    //文件上传真实按钮
    fclick:function(){
        with(obj) {
            style.posTop = event.srcElement.offsetTop;
            var x = event.x - offsetWidth / 2;
            if(x < event.srcElement.offsetLeft) x = event.srcElement.offsetLeft;
            if(x > event.srcElement.offsetLeft + event.srcElement.offsetWidth - offsetWidth) x = event.srcElement.offsetLeft + event.srcElement.offsetWidth - offsetWidth;
            style.posLeft = x;
        }
    },
    initDownList:function(){
        var g = this;
        var obj = {'data1':[
            {statusCode:'1010',statusDetail:'待审核'},
            {statusCode:'1011',statusDetail:'录入审核拒绝'},
            {statusCode:'1020',statusDetail:'可融资发票'}]};
        tabHeadSearch.clickElement(obj,g.cfgId,"businessDealStatus");
    },
	initGridTable: function() {
		var g = this;
        if(g.cfgId == "InvoicePre1"){
            $("#jqgh_g_InvoicePre1_rn").append("序号");
            $(".jqgrid-rownum").css({
                "width":"100px",
                "text-align":"center"
            });
        }else{
            $("#jqgh_g_InvoicePre2_rn").append("序号");
        }
		var cfgData = {};
		//核心企业表格配置
		if(g.cfgId == "InvoicePre1") {
			//配置表格
			cfgData = {
				url:_ctxPath+"/avf/invoice/waitList.json",//获取后端数据
				rownumbers: true,
				rowNum: 10,
                loadonce: false,
                mtype : "get",
				colModel: [{
					name: "id", //列显示的名称
					index: "id", //传到服务器端用来排序的列名称
					hidden: true //隐藏不显示这一组
				},{
                    label:"录入编号",
                    name:"docNo",
                    index:"docNo",
                    hidden:false
                },{
					label: "供应商",
					name: "supplyShortName",
					index: "supplyShortName",
                    formatter: function(value, id, rowdata) {
						var url ="/pbm/verdor/verdorDetail?supplyCode="+rowdata.supplyCode;
                        return '<a href="'+url+'">' + rowdata.supplyShortName + '</a>';
                    }
				}, {
					label: "合计金额(元)<b class='sorting no_sort' data='totalMoney'></b>",
					name: "totalMoney",
					index: "totalMoney",
					width:140,
					formatter: function(value, id, rowdata) {
						return '<span class="font18 color555 bold">￥' + $.formatMoney(rowdata.totalMoney,2) + '</span>';
					}
				}, {
					label: "数量(张)<b class='sorting no_sort' data='invoiceTotalNumber'></b>",
					name: "invoiceTotalNumber",
					index: "invoiceTotalNumber",
					formatter: function(value, id, rowdata) {
						return '<span class="font18 color555 bold">' + rowdata.invoiceTotalNumber + '</span>';
					}
				}, {
					label: "状态<b class='b_btn b_state' data='businessDealInfo'></b>",
					name: "businessDealInfo",
					index: "businessDealInfo"
				}, {
					label: "操作",
                    name: "businessDealStatus",
                    index: "businessDealStatus",
					width:150,
					formatter: function(value, id, rowdata) {
						//待审核
						var btnHtml = "";
						if(rowdata.businessDealStatus == "1010"){
							var url = "/avf/invoice/toInvoiceDetailPage?type=true&id="+rowdata.id;
                            btnHtml =  '<a href="'+url+'"  class="table_btn" data-id="' + rowdata.id + '">立即审核</a>';
						}
						//录入审核拒绝
						if(rowdata.businessDealStatus == "1011"){
                            var url = "/avf/invoice/toInvoiceDetailPage?type=false&id="+rowdata.id;
                            btnHtml = '<a href="'+url+'"  class="sxf_btn icon_detail" data-id="' + rowdata.id + '" title="查看明细"></a>';
						}
						//审核通过
                        if(rowdata.businessDealStatus == "1020"){
                            url = "/avf/invoice/toInvoiceDetailPage?type=false&id="+rowdata.id;
                            btnHtml = '<a href="'+url+'"  class="sxf_btn icon_detail" data-id="' + rowdata.id + '" title="查看明细"></a>';
                        }
                        return '<div class="coop_a">'+btnHtml+'<span class="sxf_btn icon_edit mgl16 editRow" data-id="' + rowdata.id + '" title="编辑"></span><span class="sxf_btn icon_delete mgl16 deleteRow" data-id="' + rowdata.id + '" title="删除"></span></div>';
					}
				}]
			}
		}
		//供应商表格配置
		if(g.cfgId == "InvoicePre2") {
			cfgData = {
                url:_ctxPath+"/avf/invoice/waitList.json",//获取后端数据
                rownumbers: true,
                rowNum: 10,
                loadonce: false,
                mtype : "get",
				colModel: [{
					name: "id", //列显示的名称
					index: "id", //传到服务器端用来排序的列名称
					hidden: true //隐藏不显示这一组
				}, {
					label: "序号",
					name: "docNo",
					index: "docNo",
					width: 80,
					hidden:true
				}, {
					label: "发票代码",
					name: "invoiceCode",
					index: "invoiceCode",
					width:220,
					formatter: function(value, id, rowdata) {
						return '<span>' + rowdata.invoiceCode + '</span>';
					}
				}, {
					label: "发票号码",
					name: "invoiceNo",
					index: "invoiceNo",
					formatter: function(value, id, rowdata) {
						return '<span>' + rowdata.invoiceNo + '</span>';
					}
				}, {
					label: "价税合计(元)<b class='sorting desc' data='vatMoney'></b>",
					name: "vatMoney",
					index: "vatMoney",
					width:260,
                    formatter:function(value,id,rowdata){
                        return '<span class="font18 bold">￥'+$.formatMoney(rowdata.vatMoney,2)+'</span>';
                    }
				}, {
					label: "金额(元)<b class='sorting desc' data='taxFreeSum'></b>",
					name: "taxFreeSum",
					index: "taxFreeSum",
					width:260,
					formatter: function(value, id, rowdata) {
						return '<span class="font18 bold">￥' + $.formatMoney(rowdata.taxFreeSum,2) + '</span>';
					}
				}, {
					label: "税额(元)<b class='sorting desc' data='vatSum'></b>",
					name: "vatSum",
					index: "vatSum",
                    width:160,
					formatter:function(value,id,rowdata){
						return '<span>￥'+$.formatMoney(rowdata.vatSum,2)+'</span>';
					}
				}, {
					label: "所属公司",
					name: "companyShortName",
					index: "companyShortName",
					width: 180,
                    formatter: function(value, id, rowdata) {
                        var url ="/pbm/company/companyDetail?companyCode="+rowdata.companyCode;
                        return '<a href="'+url+'">' + rowdata.companyShortName + '</a>';
                    }
				}, {
					label: "开票日期",
					name: "invoDate",
					index: "invoDate",
                    width: 180,
				}, {
					label: "批次号",
					name: "batchNumber",
					index: "batchNumber"
				}, {
                    label: "状态<b class='b_btn b_state' data='businessDealInfo'></b>",
                    name: "businessDealInfo",
                    index: "businessDealInfo"
                }, {
					label: "操作",
					name: "",
					index: "",
					width: 150,
					formatter: function(value, id, rowdata) {
						return '<div class="coop_a fl"><span class="sxf_btn icon_edit editRow" data-id="' + rowdata.id + '" title="编辑"></span><span class="sxf_btn icon_delete deleteRow ml20" data-id="' + rowdata.id + '" title="删除"></span></div>';
					}
				}]
			}
		}
		return cfgData;
	},
    //初始化高级查询表单
    initSearchForm:function(){
    	var g = this;
        if(g.cfgId == "InvoicePre1"){
    	    g.ComboBoxCode = "supplyCode";
            g.ComboBoxName = "supplyName";
            g.labelName = "供应商";
            g.ComboBoxUrl = "/avf/financingRelConfigure/findRelByCompanyCode.json";
        }else{
            g.ComboBoxCode = "companyCode";
            g.ComboBoxName = "companyName";
            g.labelName = "核心企业";
            g.ComboBoxUrl = "/avf/financingRelConfigure/findRelBySupplyCode.json";
        }
        var options = {
            id: "searchForm1", //表单id
            renderTo: "formBox1",//表单容器id
            submitId:"submitId",//提交按钮id
            tableId:g.cfgId,//要刷新的表格id
            title:"高级查询",//查询标题
            formGrid: [{
                xtype: "ComboBox",
                field: [g.ComboBoxCode], // 表示哪些值需要提交到后端
                name: g.ComboBoxName,
                labelWidth: 120,
                id: g.ComboBoxCode,
                title: g.labelName,
                width: 280,
                allowBlank: true,
                displayText: "请选择供应商",
                async: true, // 是否异步，true为异步
                store: {
                    type:"get",
                    url: _ctxPath + g.ComboBoxUrl
                }, // 从后台获取数据的地址
                editable: true, // 是否可编辑
                loadMask: true, // 是否有遮罩层
                showSearch: false, // 是否展开下拉框
                searchText:g.ComboBoxCode, // 下拉框的内容
                canClear: true,
                deforeLoad: function(store) {},
                afterLoad: function(data) {

                },
                afterSelect:function(data){

                }
            },
            //     {
            //     xtype: "FieldGroup",
            //     width:500,
            //     itemspace:10,
            //     items: [{
            //         xtype: "NumberField",
            //         width: 100,
            //         labelWidth: 120,
            //         precision : 2,
            //         value:"",
            //         allowBlank: false,
            //         // minlength:1,
            //         title:"金额范围",
            //         minValue:1,
            //         displayText: "最小金额",
            //         name: "minMoney",
            //         // unit: "元",
            //         id:"minMoney",
            //         checkInitValue:false,
            //         validateText: "请输入正确的金额！"
            //     },{
            //         xtype: "NumberField",
            //         precision : 2,
            //         labelWidth: 68,
            //         width: 80,
            //         value:"",
            //         title: "到",
            //         // minlength:1,
            //         minValue:1,
            //         id:"maxMoney",
            //         name: "maxMoney",
            //         checkInitValue:false,
            //         allowBlank: false,
            //         displayText: "最大金额", // 显示在文本框内的提示语
            //         validateText:"最大金额必须大于最小金额",
            //         unit: "元",
            //         // afterValidate:function(){
            //         //     var minMoney = parseFloat(EUI.getCmp("minMoney").getValue().toFixed(2));
            //         //     var maxMoney = parseFloat(EUI.getCmp("maxMoney").getValue().toFixed(2));
            //         //     EUI.getCmp("vatMoney").setValue(parseFloat((taxFreeSum+vatSum).toFixed(2)));
            //         // },
            //         validater:function(value){
            //             var minMoney = parseFloat(EUI.getCmp("minMoney").getValue().toFixed(2));
            //             if(minMoney>value){
            //                 return false;
            //             }
            //         }
            //     }]
            // },
                {
                xtype: "FieldGroup",
                width:500,
                itemspace:10,
                items: [{
                    xtype: "NumberField",
                    width: 85,
                    labelWidth: 120,
                    precision : 0,
                    // value:0,
                    allowBlank: true,
                    // minlength:1,
                    title:"发票数量",
                    // minValue:1,
                    displayText: "最小发票数量",
                    name: "minInvoiceNum",
                    unit: "张",
                    id:"minInvoiceNum",
                    checkInitValue:false,
                    validateText: "请输入正确的发票数量！"
                },{
                    xtype: "NumberField",
                    precision : 0,
                    labelWidth: 45,
                    width: 85,
                    // value:0,
                    title: "到",
                    // minlength:1,
                    // minValue:1,
                    id:"maxInvoiceNum",
                    name: "maxInvoiceNum",
                    checkInitValue:false,
                    allowBlank: true,
                    displayText: "最大发票数量", // 显示在文本框内的提示语
                    validateText:"最大发票数量不能小于最小发票数量",
                    unit: "张",
                    validater:function(value){
                        var minInvoiceNum = parseFloat(EUI.getCmp("minInvoiceNum").getValue().toFixed(2));
                        if(minInvoiceNum>value){
                            return false;
                        }
                    }
                }]
            },{
                xtype: "ComboBox",
                field: ["businessDealStatus"], // 表示哪些值需要提交到后端
                name: "name",
                labelWidth: 120,
                id: "businessDealStatus",
                title: "状态",
                width: 280,
                allowBlank: true,
                displayText: "请选择状态",
                async: true, // 是否异步，true为异步
                // store: {
                //     type:"get",
                //     url: _ctxPath + "/avf/financingRelConfigure/findRelByCompanyCode.json"
                // }, // 从后台获取数据的地址
                data : [{
                    businessDealStatus : "1010",
                    name : "录入待审核"
                }, {
                    businessDealStatus : "1011",
                    name : "录入审核拒绝"
                }, {
                    businessDealStatus : "1020",
                    name : "可融资发票"
                }],
                editable: true, // 是否可编辑
                loadMask: true, // 是否有遮罩层
                showSearch: false, // 是否展开下拉框
                searchText: "businessDealStatus", // 下拉框的内容
                canClear: true,
                deforeLoad: function(store) {},
                afterLoad: function(data) {

                },
                afterSelect:function(data){

                }
            }] //表单配置
        }
        g.searchWin = new showSearchWin(options);
	}
});